{% extends "base.html" %}

{% block title %}Dashboard - Nigzsu{% endblock %}

{% block content %}
<div class="dashboard-header text-center">
    <div class="container">
        <h1>Business Intelligence Dashboard</h1>
        <p class="mb-0">Transform your CCTV data into actionable insights</p>
    </div>
</div>

<div class="container-fluid">
    <!-- Advanced Filter Builder Section -->
    <div class="filter-hub">
        <div class="row">
            <div class="col-lg-9">
                <div class="filter-builder-container">
                    <div class="filter-builder-header">
                        <h5 class="filter-title">
                            <i class="filter-icon"></i>
                            Advanced Data Filters
                        </h5>
                        <div class="filter-actions">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="collapseFilters">
                                <i class="collapse-icon"></i> Collapse
                            </button>
                            <button type="button" class="btn btn-sm btn-primary" id="applyFilters">
                                Apply Filters
                            </button>
                        </div>
                    </div>
                    
                    <div class="filter-builder-content" id="filterBuilderContent">
                        <!-- Primary Condition Group (Match ALL) -->
                        <div class="condition-group" data-logic="AND">
                            <div class="group-header">
                                <span class="logic-label">Match ALL of these conditions</span>
                                <button type="button" class="btn btn-sm btn-link group-toggle" aria-label="Toggle group">
                                    <i class="toggle-icon"></i>
                                </button>
                            </div>
                            <div class="conditions-container" id="primaryConditions">
                                <!-- Default condition will be added by JS -->
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary add-condition" data-group="primary">
                                <i class="plus-icon"></i> Add condition
                            </button>
                        </div>

                        <!-- Secondary Condition Group (Match ANY) -->
                        <div class="condition-group secondary-group" data-logic="OR" style="display: none;">
                            <div class="group-header">
                                <span class="logic-label">And match ANY of these conditions</span>
                                <button type="button" class="btn btn-sm btn-link group-toggle" aria-label="Toggle group">
                                    <i class="toggle-icon"></i>
                                </button>
                            </div>
                            <div class="conditions-container" id="secondaryConditions">
                                <!-- Conditions will be added by JS -->
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary add-condition" data-group="secondary">
                                <i class="plus-icon"></i> Add condition
                            </button>
                        </div>

                        <div class="group-controls">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="addConditionGroup">
                                <i class="plus-icon"></i> Add OR condition group
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3">
                <div class="saved-filters-panel">
                    <h6 class="panel-title">Saved Views</h6>
                    <div class="saved-filters-list" id="savedFiltersList">
                        <div class="saved-filter-item active">
                            <span class="filter-name">All Data</span>
                            <span class="filter-count">1.8k</span>
                        </div>
                        <div class="saved-filter-item">
                            <span class="filter-name">Today's Traffic</span>
                            <span class="filter-count">247</span>
                        </div>
                        <div class="saved-filter-item">
                            <span class="filter-name">Peak Hours</span>
                            <span class="filter-count">89</span>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary w-100 mt-2" id="saveCurrentFilter">
                        Save current filter
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Tabs -->
    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="time-tab" data-bs-toggle="tab" data-bs-target="#time-metrics" type="button" role="tab">Time-based Metrics</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="demographics-tab" data-bs-toggle="tab" data-bs-target="#demographics-metrics" type="button" role="tab">Demographics</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="entry-exit-tab" data-bs-toggle="tab" data-bs-target="#entry-exit-metrics" type="button" role="tab">Entry/Exit Metrics</button>
        </li>
    </ul>

    <div class="tab-content" id="dashboardTabContent">
        <!-- Time-based Metrics Tab -->
        <div class="tab-pane fade show active" id="time-metrics" role="tabpanel">
            <div class="row">
                <div class="col-lg-6">
                    <div class="chart-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="chart-title">Live Occupancy</h6>
                            <div class="export-controls">
                                <button class="btn btn-sm btn-outline-primary export-btn" onclick="exportChart('liveOccupancy', 'png')">PNG</button>
                                <button class="btn btn-sm btn-outline-secondary export-btn" onclick="exportChart('liveOccupancy', 'csv')">CSV</button>
                            </div>
                        </div>
                        <div id="liveOccupancy" class="chart-loading">Loading chart...</div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="chart-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="chart-title">Foot Traffic Over Time</h6>
                            <div class="export-controls">
                                <button class="btn btn-sm btn-outline-primary export-btn" onclick="exportChart('footTraffic', 'png')">PNG</button>
                                <button class="btn btn-sm btn-outline-secondary export-btn" onclick="exportChart('footTraffic', 'csv')">CSV</button>
                            </div>
                        </div>
                        <div id="footTraffic" class="chart-loading">Loading chart...</div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-6">
                    <div class="chart-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="chart-title">Occupancy Trend by Day</h6>
                            <div class="export-controls">
                                <button class="btn btn-sm btn-outline-primary export-btn" onclick="exportChart('occupancyTrend', 'png')">PNG</button>
                                <button class="btn btn-sm btn-outline-secondary export-btn" onclick="exportChart('occupancyTrend', 'csv')">CSV</button>
                            </div>
                        </div>
                        <div id="occupancyTrend" class="chart-loading">Loading chart...</div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="chart-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="chart-title">Weekly Traffic Pattern</h6>
                            <div class="export-controls">
                                <button class="btn btn-sm btn-outline-primary export-btn" onclick="exportChart('weeklyPattern', 'png')">PNG</button>
                                <button class="btn btn-sm btn-outline-secondary export-btn" onclick="exportChart('weeklyPattern', 'csv')">CSV</button>
                            </div>
                        </div>
                        <div id="weeklyPattern" class="chart-loading">Loading chart...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Demographics Tab -->
        <div class="tab-pane fade" id="demographics-metrics" role="tabpanel">
            <div class="row">
                <div class="col-lg-6">
                    <div class="chart-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="chart-title">Age Distribution</h6>
                            <div class="export-controls">
                                <button class="btn btn-sm btn-outline-primary export-btn" onclick="exportChart('ageDistribution', 'png')">PNG</button>
                                <button class="btn btn-sm btn-outline-secondary export-btn" onclick="exportChart('ageDistribution', 'csv')">CSV</button>
                            </div>
                        </div>
                        <div id="ageDistribution" class="chart-loading">Loading chart...</div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="chart-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="chart-title">Gender Breakdown</h6>
                            <div class="export-controls">
                                <button class="btn btn-sm btn-outline-primary export-btn" onclick="exportChart('genderBreakdown', 'png')">PNG</button>
                                <button class="btn btn-sm btn-outline-secondary export-btn" onclick="exportChart('genderBreakdown', 'csv')">CSV</button>
                            </div>
                        </div>
                        <div id="genderBreakdown" class="chart-loading">Loading chart...</div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12">
                    <div class="chart-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="chart-title">Average Dwell Time by Age Group</h6>
                            <div class="export-controls">
                                <button class="btn btn-sm btn-outline-primary export-btn" onclick="exportChart('dwellTimeByAge', 'png')">PNG</button>
                                <button class="btn btn-sm btn-outline-secondary export-btn" onclick="exportChart('dwellTimeByAge', 'csv')">CSV</button>
                            </div>
                        </div>
                        <div id="dwellTimeByAge" class="chart-loading">Loading chart...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Entry/Exit Metrics Tab -->
        <div class="tab-pane fade" id="entry-exit-metrics" role="tabpanel">
            <div class="row">
                <div class="col-lg-6">
                    <div class="chart-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="chart-title">Peak Entry Times by Gender</h6>
                            <div class="export-controls">
                                <button class="btn btn-sm btn-outline-primary export-btn" onclick="exportChart('peakEntryTimes', 'png')">PNG</button>
                                <button class="btn btn-sm btn-outline-secondary export-btn" onclick="exportChart('peakEntryTimes', 'csv')">CSV</button>
                            </div>
                        </div>
                        <div id="peakEntryTimes" class="chart-loading">Loading chart...</div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="chart-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="chart-title">Entry-to-Exit Ratio</h6>
                            <div class="export-controls">
                                <button class="btn btn-sm btn-outline-primary export-btn" onclick="exportChart('entryExitRatio', 'png')">PNG</button>
                                <button class="btn btn-sm btn-outline-secondary export-btn" onclick="exportChart('entryExitRatio', 'csv')">CSV</button>
                            </div>
                        </div>
                        <div id="entryExitRatio" class="chart-loading">Loading chart...</div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12">
                    <div class="chart-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="chart-title">Demographic Flow</h6>
                            <div class="export-controls">
                                <button class="btn btn-sm btn-outline-primary export-btn" onclick="exportChart('demographicFlow', 'png')">PNG</button>
                                <button class="btn btn-sm btn-outline-secondary export-btn" onclick="exportChart('demographicFlow', 'csv')">CSV</button>
                            </div>
                        </div>
                        <div id="demographicFlow" class="chart-loading">Loading chart...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Section for Clients -->
    <div class="filter-section mt-4">
        <h5>Upload CSV Data</h5>
        <p class="text-muted">Upload CSV files for admin review (does not affect dashboard data)</p>
        <div class="upload-area" id="uploadArea">
            <input type="file" id="csvUpload" accept=".csv" style="display: none;">
            <div class="upload-content">
                <h6>Drop CSV file here or click to browse</h6>
                <p class="text-muted">Supported format: CSV files only</p>
                <button type="button" class="btn btn-primary" onclick="document.getElementById('csvUpload').click()">
                    Choose File
                </button>
            </div>
        </div>
        <div id="uploadStatus" class="mt-3"></div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}